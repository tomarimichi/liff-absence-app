<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body style="padding:20px;font-family:sans-serif;">
  <h3>欠席連絡フォーム</h3>
  <div style="color:green;font-weight:bold;">
    ユーザーID: <span id="userId">読み込み中...</span>
  </div>
  <p>test 12:21</p>
  <p>欠席理由: 
    <select id="reason">
      <option>体調不良</option>
      <option>通院</option>
      <option>家庭事情</option>
    </select>
  </p>
  <p>欠席日: <input type="date" id="nextdate"></p>
  <button onclick="submitAbsence()" style="padding:12px 24px;font-size:16px;background:#00b900;color:white;border:none;border-radius:5px;">欠席連絡を送信</button>

  <script>
    async function initLiff() {
      try {
        await liff.init({ liffId: '2008657935-a7glOyOk' });
        console.log('LIFF init成功');
        
        if (!liff.isLoggedIn()) {
          console.log('未ログイン → ログイン要求');
          liff.login({ redirectUri: window.location.href });
          return;
        }
        
        console.log('ログイン済み');
        
        const idToken = liff.getDecodedIDToken();
        console.log('IDトークン:', idToken ? '取得成功' : 'null');
        
        if (idToken && idToken.sub) {
          document.getElementById('userId').textContent = idToken.sub.substring(0, 20) + '...';
          document.getElementById('userId').style.color = 'green';
        } else {
          document.getElementById('userId').textContent = 'ID取得失敗（リロード）';
          document.getElementById('userId').style.color = 'red';
        }
        
        document.getElementById('nextdate').valueAsDate = new Date();
        
      } catch (error) {
        console.error('LIFFエラー:', error);
        document.getElementById('userId').textContent = 'LIFF初期化エラー: ' + error.message;
        document.getElementById('userId').style.color = 'red';
      }
    }

    async function submitAbsence() {
      const idToken = liff.getDecodedIDToken();
      const data = {
        userId: idToken.sub,
        reason: document.getElementById('reason').value,
        nextdate: document.getElementById('nextdate').value
      };

      const GAS_URL = 'https://script.google.com/macros/s/AKfycbza4BIMHtH_OK0swWRbCmIK2prPToVgvCX7TWQkNx-ImKD-OLXbF_a-h5Iy294XdcleYA/exec';

      try {
        await fetch(GAS_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });

        await liff.sendMessages([{
          type: 'text',
          text: `【欠席連絡】\n利用者ID: ${data.userId.substring(0,15)}...\n欠席理由: ${data.reason}\n欠席日: ${data.nextdate}`
        }]);

        alert('✅ 欠席連絡を送信しました！\nスプレッドシートを確認してください');
        liff.closeWindow();

      } catch (e) {
        await liff.sendMessages([{
          type: 'text',
          text: `【欠席連絡】\n利用者ID: ${data.userId.substring(0,15)}...\n欠席理由: ${data.reason}\n欠席日: ${data.nextdate}\n（送信確認中）`
        }]);
        alert('✅ LINE通知完了！GAS確認を');
      }
    }

    initLiff();
  </script>
</body>
</html>

